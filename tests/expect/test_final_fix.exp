#!/usr/bin/expect

# Determine repo root from this script location (tests/expect -> repo root)
set script_dir [file dirname [info script]]
set root [file normalize [file join $script_dir .. ..]]

# Set timeout
set timeout 30

# Start rigel with final fix
spawn env RIGEL_TEST_MODE=1 PROVIDER=ollama [file join $root rigel-final-fix] --termflow

# Wait for welcome message and prompt
expect "✦ Rigel - AI Coding Agent"
expect "Commands: Type / for commands (Ctrl+C to exit)"
expect "✦"
sleep 1

puts "\n=== Testing final blank line preservation fix ==="
puts "Performing exact user sequence: aaaa + Ctrl+J + bbbb + Ctrl+J + cccc + Ctrl+J"

# Exact user sequence to test blank line preservation
send "aaaa"
puts "Sent: aaaa"
sleep 0.5

send "\x0A"  
puts "Sent: Ctrl+J (first)"
sleep 0.5

send "bbbb"  
puts "Sent: bbbb"
sleep 0.5

send "\x0A"
puts "Sent: Ctrl+J (second)"  
sleep 0.5

send "cccc"
puts "Sent: cccc"
sleep 0.5

send "\x0A"
puts "Sent: Ctrl+J (third)"
sleep 0.5

send "dddd"
puts "Sent: dddd"
sleep 1

puts "=== Should show blank line preserved before ✦ aaaaa ==="

# Exit
send "\x03"
sleep 0.5
send "\x03"
expect eof

puts "=== Final test completed - blank line should be preserved ==="
